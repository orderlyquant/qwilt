{
  "hash": "b367b7cc14f20c797fd24a74025bab10",
  "result": {
    "markdown": "---\ntitle: \"Is Correlation Enough?\"\ndescription: |\n  Questioning whether the mathematical construct: \"correlation\" is the\n  best measure of determining substitute securities\nauthor: Brandon Farr\ndate: 02-07-2021\ncategories: ['tidyquant', 'tibbletime', 'finance']\n---\n\n\n\n\n**Short-comings of previous analysis**\n\n- we were lucky that the example dataset showed extreme \"non-stationarity\"\n  in correlation between stocks\n- this naturally raises the question of whether correlation (not to mention\n  which correlation: full data-set, rolling window, ...) is the appropriate\n  measure to use in seeking substitutes\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)  # for tidy/dplyr work\nlibrary(rvest)      # for web-scraping\nlibrary(tidyquant)  # for quant work (tiingo pricing, tq_mutate ...)\nlibrary(hrbrthemes) # preferred theming base\nlibrary(oqthemes)   # oq colors\n```\n:::\n\n\nOnce this chunk has been run successfully, just load the data from the local\ncsv`s: `sp500.csv` and `peer_pricing.csv`.\n\n\nAgain, load the pre-stored data, and calculate returns.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npeer_pricing_tbl <- read_csv(\"data/peer_pricing.csv\")\n\nglimpse(peer_pricing_tbl)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 1,764\nColumns: 14\n$ symbol      <chr> \"AAPL\", \"AAPL\", \"AAPL\", \"AAPL\", \"AAPL\", \"AAPL\", \"AAPL\", \"A…\n$ date        <dttm> 2020-01-31, 2020-02-03, 2020-02-04, 2020-02-05, 2020-02-0…\n$ open        <dbl> 320.93, 304.30, 315.31, 323.52, 322.57, 322.37, 314.18, 32…\n$ high        <dbl> 322.68, 313.49, 319.64, 324.76, 325.22, 323.40, 321.55, 32…\n$ low         <dbl> 308.29, 302.22, 313.63, 318.95, 320.26, 318.00, 313.85, 31…\n$ close       <dbl> 309.51, 308.66, 318.85, 321.45, 325.21, 320.03, 321.55, 31…\n$ volume      <dbl> 49897096, 43496401, 34154134, 29706718, 26356385, 29421012…\n$ adjusted    <dbl> 76.71393, 76.50326, 79.02891, 79.67334, 80.60527, 79.51223…\n$ adjHigh     <dbl> 79.97820, 77.70040, 79.22472, 80.49374, 80.60775, 80.34951…\n$ adjLow      <dbl> 76.41155, 74.90706, 77.73510, 79.05370, 79.37839, 79.00787…\n$ adjOpen     <dbl> 79.54445, 75.42260, 78.15150, 80.18640, 79.95093, 80.09361…\n$ adjVolume   <dbl> 199588384, 173985604, 136616536, 118826872, 105425540, 117…\n$ divCash     <dbl> 0.00, 0.00, 0.00, 0.00, 0.00, 0.77, 0.00, 0.00, 0.00, 0.00…\n$ splitFactor <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…\n```\n:::\n\n```{.r .cell-code}\n# calculate returns as well\npeer_returns_tbl <- peer_pricing_tbl %>%\n  group_by(symbol) %>%\n  tq_transmute(adjusted, periodReturn, period = \"daily\", col_rename = \"return\")\n```\n:::\n\n\n\nIn a minor adjustment from last-time, begin the creation of the peers table with a direct call to `left_join`, making the two data sets more explicit versus the pipe version.\n\n\n::: {.cell}\n\n```{.r .cell-code}\naapl_peer_returns_tbl <-\n  left_join(\n    # desc\n    peer_returns_tbl %>%\n      filter(symbol == \"AAPL\") %>%\n      select(symbol, date, return),\n    \n    # desc\n    peer_returns_tbl %>%\n      filter(symbol != \"AAPL\") %>%\n      select(symbol, date, return),\n    by = \"date\",\n    suffix = c(\"_1\", \"_2\")\n  ) %>%\n  select(date, matches(\"symbol\"), everything()) %>%\n  arrange(symbol_2, date) %>%\n  filter(!(return_1 == 0 & return_2 == 0))  # remove days where returns == 0\n```\n:::\n\n\nAs we saw last time, even the \"smoothed\" representation of the 30-day\nrolling correlation exhibits significant non-stationarity.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"show\"}\nlibrary(tibbletime)\n\ncor_roll <- rollify(~cor(.x, .y), window = 30)\n\naapl_cor_tbl <-\n  aapl_peer_returns_tbl %>%\n  group_by(symbol_2) %>%\n  mutate(cor = cor_roll(return_1, return_2))\n\naapl_cor_tbl %>%\n  ggplot(aes(x = date, y = cor, color = symbol_2)) +\n  geom_hline(yintercept = 0, color = \"gray40\") +\n  geom_smooth(se = FALSE) + # default loess smoothing\n  ylim(-1, 1) +\n  labs(\n    title = \"AAPL Stock Correlation\",\n    subtitle = \"with GICS sub-industry peers\",\n    caption = \"30-trading day rolling windows\",\n    x = NULL, y = NULL, color = NULL\n  ) +\n  theme_ipsum() +\n  theme(legend.position = \"bottom\") +\n  scale_color_oq() +\n  # scale_x_date(expand = expansion(mult = c(0, 0))) +\n  # for legend to have 1 row\n  guides(col = guide_legend(nrow = 1))\n```\n\n::: {.cell-output-display}\n![](post_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n## What is a substitute\n\nWhen looking for a *substitute* for portfolio purposes, we are seeking:\n\n- a stock that will perform in line with a base security over a given time-frame\n\nWe know that period returns are the compounded result of daily returns. So,\nmaybe the correlation over the data time frame of the period returns (here\n30 days) is a better measure of a good substitute.\n\nOr, perhaps the \"active\" return of the two securities (base and substitute)\nthrough time is a better, simpler measure as it measure the actual gain/loss\nthat would be experienced by substituting.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nperiod_return = function(return) { cumprod(1 + return) %>% last() - 1}\n\npr_roll <- rollify(~period_return(.x), window = 30)\n\naapl_pr_tbl <- aapl_peer_returns_tbl %>%\n  group_by(symbol_2) %>%\n  mutate(\n    pr_1 = pr_roll(return_1),\n    pr_2 = pr_roll(return_2)\n  )\n\n\naapl_pr_tbl %>%\n  group_by(symbol_2) %>%\n  mutate(cor = cor_roll(pr_1, pr_2)) %>%\n  ggplot(aes(x = date, y = cor, color = symbol_2)) +\n  geom_hline(yintercept = 0, color = \"gray40\") +\n  geom_smooth(se = FALSE) + # default loess smoothing\n  ylim(-1, 1) +\n  labs(\n    title = \"AAPL Stock Correlation\",\n    subtitle = \"with GICS sub-industry peers\",\n    caption = \"30-trading day rolling windows\",\n    x = NULL, y = NULL, color = NULL\n  ) +\n  theme_ipsum() +\n  theme(legend.position = \"bottom\") +\n  scale_color_oq() +\n  # scale_x_date(expand = expansion(mult = c(0, 0))) +\n  # for legend to have 1 row\n  guides(col = guide_legend(nrow = 1))\n```\n\n::: {.cell-output-display}\n![](post_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "post_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}